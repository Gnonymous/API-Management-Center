name: Auto Tag on Main

on:
  push:
    branches:
      - main

concurrency:
  group: auto-tag-main
  cancel-in-progress: false

jobs:
  auto-tag:
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine bump level from commit message
        id: bump
        run: |
          set -euo pipefail
          msg="${{ github.event.head_commit.message }}"
          level="patch"
          if echo "$msg" | grep -qiE '(\[major\]|#major|breaking change)'; then
            level="major"
          elif echo "$msg" | grep -qiE '(\[minor\]|#minor)'; then
            level="minor"
          fi
          echo "level=$level" >> "$GITHUB_OUTPUT"

      - name: Check existing tag on HEAD
        id: head_tag
        run: |
          set -euo pipefail
          tag="$(git tag --points-at HEAD --list 'v*' | head -n 1 || true)"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Compute next semantic tag
        if: ${{ steps.head_tag.outputs.tag == '' }}
        id: next
        run: |
          set -euo pipefail

          latest=""
          while IFS= read -r tag; do
            if [[ "$tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)([-+].*)?$ ]]; then
              latest="$tag"
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              break
            fi
          done < <(git tag --list 'v*' --sort=-v:refname)

          if [ -z "$latest" ]; then
            major=0
            minor=1
            patch=0
          fi

          case "${{ steps.bump.outputs.level }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          next_tag="v${major}.${minor}.${patch}"
          echo "tag=$next_tag" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: ${{ steps.head_tag.outputs.tag == '' }}
        run: |
          set -euo pipefail
          tag="${{ steps.next.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "release: $tag"
          git push origin "$tag"

      - name: Summary
        run: |
          if [ -n "${{ steps.head_tag.outputs.tag }}" ]; then
            echo "HEAD already tagged: ${{ steps.head_tag.outputs.tag }}"
          else
            echo "Created tag: ${{ steps.next.outputs.tag }}"
          fi
